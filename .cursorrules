# Echo Project Rules

## ğŸ¯ Contexto del Proyecto

**Echo** es un sistema de copiado de operaciones de trading algorÃ­tmico.
- **Objetivo**: Replicar trades de masters MT4/MT5 a mÃºltiples slaves con latencia <1s
- **Arquitectura**: Monorepo Go con gRPC bidi + Named Pipes IPC
- **Stack**: Go 1.25, PostgreSQL 16, etcd v3, OpenTelemetry
- **VersiÃ³n**: 0.0.1 (MVP V1)

## ğŸš« Regla Fundamental: Independencia Total

**CRÃTICO**: Echo es un proyecto **INDEPENDIENTE** del ecosistema xKoRx/sdk y xKoRx/symphony.

### Prohibido Absolutamente
- âŒ Importar cÃ³digo de `github.com/xKoRx/sdk` (excepto referencia documental)
- âŒ Importar cÃ³digo de `github.com/xKoRx/symphony`
- âŒ Copiar patrones problemÃ¡ticos de proyectos anteriores
- âŒ Crear dependencias cruzadas con otros proyectos

### Permitido
- âœ… Usar la **arquitectura conceptual** como referencia
- âœ… Aprender de errores pasados (evitar deuda tÃ©cnica)
- âœ… Crear implementaciones **limpias desde cero**
- âœ… Documentar decisiones en ADRs

---

## ğŸ—ï¸ Arquitectura

### MÃ³dulos Independientes

```
echo/
â”œâ”€â”€ core/          go.mod independiente
â”œâ”€â”€ agent/         go.mod independiente
â”œâ”€â”€ sdk/           go.mod independiente (publicable)
â”œâ”€â”€ test_e2e/      go.mod independiente
â””â”€â”€ clients/       MQL4/MQL5 (no Go)
```

- Cada mÃ³dulo tiene su `go.mod` propio
- Go workspaces (`go.work`) solo para desarrollo local
- Sin dependencias circulares

### ComunicaciÃ³n

- **Core â†” Agent**: gRPC bidi-streaming
- **Agent â†” EAs**: Named Pipes (Windows IPC) con JSON
- **Config**: etcd v3 (live watches)
- **State**: PostgreSQL 16

---

## ğŸ“¦ Convenciones de CÃ³digo

### Go Style

- **Go 1.25 idiomÃ¡tico**
- **Nombres descriptivos** (no abreviaturas crÃ­pticas)
- **Funciones cortas** (<50 lÃ­neas)
- **Single Responsibility Principle**
- **Prefer composition over inheritance**

### Estructura de Paquetes

```go
// âœ… Correcto
core/
  internal/
    engine/          // LÃ³gica privada del core
    policy/
  pkg/
    config/          // Exportable a otros mÃ³dulos del monorepo

// âŒ Incorrecto
core/
  utils/             // Nombre vago
  helpers/           // Nombre genÃ©rico
```

### Error Handling

```go
// âœ… Correcto
func ProcessTrade(ctx context.Context, intent *TradeIntent) error {
    if err := validate(intent); err != nil {
        return fmt.Errorf("validation failed: %w", err)
    }
    return nil
}

// âŒ Incorrecto
func ProcessTrade(ctx context.Context, intent *TradeIntent) error {
    if err := validate(intent); err != nil {
        log.Println(err)  // No propagar error
    }
    return nil
}
```

---

## ğŸ”§ TelemetrÃ­a

### ImplementaciÃ³n Propia

Echo tiene su **propia implementaciÃ³n** de telemetry en `/sdk/telemetry`:

- Basada en `log/slog` + OpenTelemetry
- Sin dependencias externas problemÃ¡ticas (no zeromq, etc.)
- API limpia y simple

### Uso Obligatorio

```go
import "github.com/xKoRx/echo/sdk/telemetry"

// âœ… Correcto
client, err := telemetry.New(ctx, "echo-core", "production")
if err != nil {
    panic(err)
}
defer client.Shutdown(ctx)

// Logs estructurados
client.Info(ctx, "Trade copied", 
    attribute.String("trade_id", id),
)

// MÃ©tricas
client.RecordCounter(ctx, "trades.copied", 1)

// Trazas
ctx, span := client.StartSpan(ctx, "copy_trade")
defer span.End()
```

### Atributos en Contexto

```go
// Al inicio de operaciÃ³n
ctx = telemetry.AppendCommonAttrs(ctx,
    attribute.String("component", "engine"),
)

ctx = telemetry.AppendEventAttrs(ctx,
    attribute.String("trade_id", id),
)

// Los logs/mÃ©tricas heredan estos atributos automÃ¡ticamente
client.Info(ctx, "Processing")  // trade_id incluido
```

---

## ğŸ—„ï¸ ConfiguraciÃ³n

### etcd Obligatorio

Toda configuraciÃ³n **DEBE** venir de etcd:

```go
// âœ… Correcto
import clientv3 "go.etcd.io/etcd/client/v3"

etcdClient, err := clientv3.New(clientv3.Config{
    Endpoints: []string{"localhost:2379"},
})
defer etcdClient.Close()

resp, err := etcdClient.Get(ctx, "/echo/policy/max_spread")
```

### Excepciones ÃšNICAS

Solo estas variables pueden usarse con `os.Getenv`:

- `ENV` (environment: development, production)
- `HOST_KEY` (identificador de host)
- `hostname` (via `os.Hostname()`)

```go
// âœ… Permitido
env := os.Getenv("ENV")
if env == "" {
    env = "development"
}

// âŒ Prohibido
maxSpread := os.Getenv("MAX_SPREAD")  // Debe venir de etcd
```

---

## ğŸ§ª Testing

### Cobertura Objetivo

- **Core**: â‰¥95%
- **Agent**: â‰¥95%
- **SDK**: â‰¥95%
- **E2E**: Flujos crÃ­ticos completos

### Estructura

```go
// âœ… Correcto
func TestEngine_ProcessIntent_Success(t *testing.T) {
    // Arrange
    engine := NewEngine(mockRepo, mockPolicy)
    intent := &TradeIntent{...}
    
    // Act
    err := engine.ProcessIntent(ctx, intent)
    
    // Assert
    require.NoError(t, err)
    assert.Equal(t, expected, actual)
}
```

### Mocks

Usar `testify/mock`:

```go
type MockRepository struct {
    mock.Mock
}

func (m *MockRepository) SaveTrade(ctx context.Context, trade *Trade) error {
    args := m.Called(ctx, trade)
    return args.Error(0)
}
```

---

## ğŸ“ Contratos (Proto)

### UbicaciÃ³n

Todos los `.proto` viven en `/sdk/proto/v1/`:

```
sdk/
  proto/
    v1/
      common.proto
      trade.proto
      agent.proto
    buf.yaml
    buf.gen.yaml
  pb/               # CÃ³digo generado
    v1/
```

### GeneraciÃ³n

```bash
cd sdk/proto
./generate.sh

# O desde raÃ­z
make proto
```

### Versionado

- **v1**: Primera versiÃ³n estable
- **Backward compatibility**: No breaking changes en v1
- **Deprecation**: Marcar campos obsoletos con `[deprecated=true]`

---

## ğŸ”’ Idempotencia

### trade_id como Clave

```go
// Generar con UUIDv7 (ordenable por tiempo)
import "github.com/google/uuid"

tradeID := uuid.NewV7().String()  // ej: "01912345-6789-7abc-def0-123456789abc"
```

### DeduplicaciÃ³n

```go
// Core debe mantener map de trade_ids procesados
type TradeRegistry struct {
    mu     sync.RWMutex
    trades map[string]*TradeState
}

func (r *TradeRegistry) IsProcessed(tradeID string) bool {
    r.mu.RLock()
    defer r.mu.RUnlock()
    _, exists := r.trades[tradeID]
    return exists
}
```

---

## ğŸš€ Performance

### Latencia

- **Objetivo**: p95 < 100ms intra-host
- **MediciÃ³n obligatoria** con mÃ©tricas:

```go
start := time.Now()
// ... operaciÃ³n ...
latency := time.Since(start).Milliseconds()
client.RecordLatency(ctx, "trade.copy", float64(latency))
```

### Concurrencia

- **Multi-slave**: Enviar comandos en paralelo con goroutines
- **Context propagation**: Propagar `context.Context` siempre

```go
// âœ… Correcto
for _, slave := range slaves {
    go func(s Slave) {
        if err := sendToSlave(ctx, s, cmd); err != nil {
            client.Error(ctx, "failed to send", err)
        }
    }(slave)
}
```

---

## ğŸ“š DocumentaciÃ³n

### Obligatorio

- `doc.go` en cada paquete pÃºblico
- Comentarios en funciones/tipos exportados
- READMEs en cada mÃ³dulo
- RFCs para decisiones arquitectÃ³nicas
- ADRs para decisiones tÃ©cnicas

### Formato

```go
// Package engine implementa el motor de copiado de trades.
//
// El engine es responsable de:
// - Validar polÃ­ticas
// - Calcular Money Management
// - Distribuir Ã³rdenes a slaves
//
// Uso bÃ¡sico:
//
//	eng := engine.New(repo, policy)
//	err := eng.ProcessIntent(ctx, intent)
//
package engine
```

---

## ğŸ”„ Git Workflow

### Branches

- `main`: ProducciÃ³n (estable)
- `develop`: IntegraciÃ³n
- `feature/*`: Features nuevos
- `fix/*`: Bug fixes
- `hotfix/*`: Fixes urgentes

### Commits

Conventional Commits:

```
feat: add SL/TP offset calculation
fix: handle StopLevel rejection correctly
docs: update RFC-001 with policy details
test: add E2E test for multi-slave scenario
chore: update dependencies
```

### Pull Requests

- **Idioma**: EspaÃ±ol
- **Template**: `docs/pull_request_template.md`
- **LÃ­mite**: â‰¤20 archivos por PR
- **Tests**: CI debe pasar (build + lint + test)
- **RevisiÃ³n**: Al menos 1 aprobaciÃ³n

---

## ğŸ›¡ï¸ Anti-Patrones Prohibidos

### CÃ³digo

- âŒ Funciones >100 lÃ­neas
- âŒ Comentarios redundantes (`// Get user` en `GetUser()`)
- âŒ Magic numbers sin constantes
- âŒ Ignorar errores (`_ = fn()`)
- âŒ Variables de un solo caracter (excepto `i`, `j` en loops)

### Arquitectura

- âŒ God objects con mÃºltiples responsabilidades
- âŒ Dependencias circulares
- âŒ Tight coupling entre mÃ³dulos
- âŒ LÃ³gica de negocio en handlers HTTP/gRPC

### TelemetrÃ­a

- âŒ Usar `fmt.Println` o `log.*` directamente
- âŒ Nombres de mÃ©tricas con IDs dinÃ¡micos
- âŒ Spans sin `defer span.End()`
- âŒ Perder contexto con `context.Background()` en medio del flujo

---

## ğŸ“‹ Checklist de PR

Antes de crear un PR:

- [ ] CÃ³digo compilado: `make build`
- [ ] Tests pasando: `make test`
- [ ] Linters limpios: `make lint`
- [ ] Cobertura â‰¥95% en cambios: `go test -cover`
- [ ] Proto regenerado si cambiÃ³: `make proto`
- [ ] DocumentaciÃ³n actualizada (READMEs, doc.go)
- [ ] Sin imports de `github.com/xKoRx/{sdk,symphony}`
- [ ] TelemetrÃ­a presente (logs, mÃ©tricas, trazas)
- [ ] Errors manejados explÃ­citamente

---

## ğŸ¯ Principios SOLID

- **S**: Single Responsibility (una clase, una razÃ³n para cambiar)
- **O**: Open/Closed (abierto a extensiÃ³n, cerrado a modificaciÃ³n)
- **L**: Liskov Substitution (subtipos intercambiables)
- **I**: Interface Segregation (interfaces pequeÃ±as y especÃ­ficas)
- **D**: Dependency Inversion (depender de abstracciones, no concreciones)

---

## ğŸ“ Contacto y Soporte

- **Equipo**: Aranea Labs - Trading Copier Team
- **DocumentaciÃ³n**: `/docs`
- **RFCs**: `/docs/RFC-*.md`
- **ADRs**: `/docs/adr/*.md`

---

**Fin de Rules - Echo Project**

